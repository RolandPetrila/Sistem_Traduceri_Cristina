name: SCE-CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read

concurrency:
  group: sce-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: SCE Validate (universal)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- PYTHON (auto-detect) ----------
      - name: Detect Python
        id: py_detect
        shell: bash
        run: |
          if ls -1 *.py >/dev/null 2>&1 || [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
            echo "has_py=true" >> $GITHUB_OUTPUT
          else
            echo "has_py=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python 3.11
        if: steps.py_detect.outputs.has_py == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps (if any)
        if: steps.py_detect.outputs.has_py == 'true'
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then pip install -r requirements.txt; fi
          if [ -f "pyproject.toml" ]; then pip install . || true; fi

      - name: Python compile check
        if: steps.py_detect.outputs.has_py == 'true'
        shell: bash
        run: |
          python -m compileall -q .

      - name: Run pytest (if present)
        if: steps.py_detect.outputs.has_py == 'true'
        shell: bash
        run: |
          python -c "import importlib.util; import sys; sys.exit(0 if importlib.util.find_spec('pytest') else 1)" \
            && pytest -q \
            || echo "pytest not installed - skipped"

      # ---------- NODE (auto-detect) ----------
      - name: Detect Node
        id: node_detect
        shell: bash
        run: |
          if [ -f "package.json" ]; then
            echo "has_node=true" >> $GITHUB_OUTPUT
          else
            echo "has_node=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node (LTS)
        if: steps.node_detect.outputs.has_node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install Node deps + test (if scripts exist)
        if: steps.node_detect.outputs.has_node == 'true'
        shell: bash
        run: |
          npm ci
          npm run -s lint || echo "no lint script - skipped"
          npm test --silent || echo "no tests or failing tests - review"

      # ---------- BASIC POLICY CHECKS ----------
      - name: Fail on forbidden secrets patterns
        shell: bash
        run: |
          # Minimal guard: nu commit-uie»ôti token-uri/chei
          if grep -RIn --exclude-dir=.git --exclude=*.png --exclude=*.jpg --exclude=*.jpeg --exclude=*.pdf \
            -E "(ghp_[A-Za-z0-9]{30,}|github_pat_[A-Za-z0-9_]{20,}|BEGIN( RSA)? PRIVATE KEY)" .; then
            echo "ERROR: Potential secret detected in repo content."
            exit 1
          fi

      - name: Summary
        shell: bash
        run: |
          echo "SCE-CI finished."
